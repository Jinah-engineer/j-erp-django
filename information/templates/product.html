{# ---------- 고기우 작업 ---------- #}
{% extends "base.html" %}
{% load static %}

{% block body %}
    <!-- side navbar -->
    {% include "navigation.html" %}
    <div class="main">

        <!--  top navbar  -->
        {% include "top-navigation.html" %}

        <!--  main content  -->
        <main class="content">


            <div class="container-fluid">

                <div class="header">
                    <h1 class="header-title">
                        기초 정보 등록
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/information/">기초 정보 등록</a></li>
                            <li class="breadcrumb-item"><a href="#">Pages</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Settings</li>
                        </ol>
                    </nav>
                </div>
                <div class="row">
                    <div class="col-md-3 col-xl-2">

                        <div class="card">

                            <div class="list-group list-group-flush" role="tablist">
                                <a class="list-group-item list-group-item-action active" href="product"
                                   role="tab">
                                    제품
                                </a>
                                <a class="list-group-item list-group-item-action"
                                   href="size"
                                   role="tab">
                                    제품 옵션 - 사이즈
                                </a>
                                <a class="list-group-item list-group-item-action"
                                   href="sheet"
                                   role="tab">
                                    제품 옵션 - 시트
                                </a>
                                <a class="list-group-item list-group-item-action"
                                   href="filling"
                                   role="tab">
                                    제품 옵션 - 필링
                                </a>
                                <a class="list-group-item list-group-item-action" href="boxing"
                                   role="tab">
                                    제품 옵션 - 포장
                                </a>
                                <a class="list-group-item list-group-item-action" href="order_type"
                                   role="tab">
                                    주문 유입 경로
                                </a>
                                <a class="list-group-item list-group-item-action" href="pay_type"
                                   role="tab">
                                    결제 유형
                                </a>
                                <a class="list-group-item list-group-item-action"
                                   href="delivery"
                                   role="tab">
                                    배송 유형
                                </a>
                                <a class="list-group-item list-group-item-action"
                                   href="emp"
                                   role="tab">
                                    직원
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-9 col-xl-10">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="category" role="tabpanel">

                                <div class="row">

                                        <div class="col-12 col-lg-4">
                                            <div class="card">

                                                <!-- 카테고리 양식 -->
                                                <div class="card-body p-3 cate-body">


                                                    {% for i in category_big %}
                                                            <div class="big-cate">
                                                                <div class="big-cate-content">
                                                                    <i class="align-middle mr-2 fas fa-fw fa-folder-open"></i>
                                                                    <a href="#">{{ i.category_big }}</a>
                                                                </div>
                                                                <div class="mid-cate">
                                                                    {% for j in category_table %}
                                                                        {% if j.category_big == i.category_big %}
                                                                            <div class="mid-cate-content" id="delbox_{{ j.category_id }}">
                                                                                <i class="align-middle mr-2 fas fa-fw fa-folder"></i>
                                                                                <a href="#"><input type="text" id="mid_{{ j.category_id }}" value="{{ j.category_mid }}"></a>
                                                                                <button class="btn btn-primary btn-sm" onclick="category_updateBtn('mid_{{ j.category_id }}', {{ j.category_id }});">
                                                                                    <i class="fas fa-check"></i>
                                                                                </button>
                                                                                <button class="btn btn-danger btn-sm" onclick="category_deleteBtn({{ j.category_id }})">
                                                                                    <i class="fas fa-times"></i>
                                                                                </button>
                                                                            </div>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                                <div class="new-mid-cate">
                                                                    <div class="new-cate-content" style="line-height: 25px;">
                                                                        <i class="align-middle mr-2 fas fa-fw fa-folder"></i>
                                                                        <input type="hidden" name="category_big" value="{{ i.category_big }}">
                                                                        <input type="text" placeholder="입력" name="category_mid">
                                                                        <button class="btn btn-primary btn-sm" type="button" onclick="category_insertBtn(this);">
                                                                            <i class="align-middle mr-2 fas fa-fw fa-plus nef" ></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    {% endfor %}

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-8">
                                            <div class="accordion" id="productInformation">
                                                {% for i in category_table %}
                                                    <div class="card">
                                                        <div class="card-header" id="heading_{{ i.category_id }}">
                                                            <h5 class="card-title my-2">
                                                                <a href="#" data-toggle="collapse" data-target="#collapse_{{ i.category_id }}" aria-controls="collapse_{{ i.category_id }}">
                                                                    {{ i.category_mid }}
                                                                </a>
                                                            </h5>
                                                        </div>
                                                        <div id="collapse_{{ i.category_id }}" class="collapse" aria-labelledby="heading_{{ i.category_id }}" data-parent="#productInformation">
                                                            <div class="card-body">
                                                                <table class="table">
                                                                    <thead>
                                                                    <!-- 표 양식 -->
                                                                    <tr>
                                                                        <th style="width:10%; text-align: center;">번호</th>
                                                                        <th style="width:25%">분류</th>
                                                                        <th style="width:25%">이름</th>
                                                                        <th style="width:20%">가격</th>
                                                                        <th style="width:20%;"></th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    <!-- 새로운 정보를 입력받을 공란 -->
                                                                    <tr>
                                                                        <td style="text-align: center;">신규</td>
                                                                        <td><input type="text" id="baseMid_{{ i.category_id }}" value="{{ i.category_mid }}" readonly></td>
                                                                        <td><input type="text" placeholder="입력" id="newName_{{ i.category_id }}"></td>
                                                                        <td><input type="text" placeholder="입력" id="newPrice_{{ i.category_id }}"></td>
                                                                        <td class="table-action" style="text-align: center;">
                                                                            <button class="btn mb-1 btn-primary" type="button" onclick="product_insertBtn({{ i.category_id }});">등록
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                    <!-- DB에서 조회할 정보 / 내림차순 정렬 -->
                                                                    {% for j in product_table %}
                                                                        {% if i.category_id == j.category_id_id %}
                                                                        <tr id="databox_{{ j.product_id }}">
                                                                            <td class="d-none d-md-table-cell" style="text-align: center">{{ j.product_id }} </td>
                                                                            <td class="d-none d-md-table-cell">{{ i.category_mid }} </td>
                                                                            <td class="d-none d-md-table-cell">{{ j.product_name }} </td>
                                                                            <td class="d-none d-md-table-cell">{{ j.product_price }} </td>
                                                                            <td class="" style="text-align: center;">
                                                                                <button class="btn mb-1 btn-danger" id="changeBtn_{{ j.product_id }}" data-toggle="modal" data-target="#sizedModalLg"
                                                                                        onclick="paging({{ j.product_id }})">수정
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                        {% endif %}
                                                                    {% endfor %}

                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}

                                            </div>
                                        </div>

                                </div>

                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- update, delete modal -->
        <div class="modal fade" id="sizedModalLg" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="font-family: 'NanumSquareB;" class="modal-title">상품 정보 수정</h2>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <i class='fas fa-times'></i>
                        </button>
                    </div>
                    <div class="modal-body m-3">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label class="form-label">번호</label>
                                                <div class="update_area">

                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">분류</label>
                                                <div class="update_area">

                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">이름</label>
                                                <div class="update_area">

                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">가격</label>
                                                <div class="update_area">

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div style="margin: 0 auto;">
                                    <button id='updBtn' type="button" class="btn btn-success" onclick="product_updateBtn();">저장</button>
                                    <button id='delBtn' type="button" class="btn btn-danger" onclick="product_deleteBtn();">삭제</button>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- END  modal -->

        {% include "footer.html" %}
    </div>

{% endblock %}

{% block javascript %}
    <script src="{% static '/dist/js/app.js' %}"></script>
    <script src="{% static '/dist/js/settings.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <script>
        <!-- 비동기 처리를 위한 사전 처리 -->
        function getCookie(name) {
            console.log(1);
            var cookieValue = null;
            if(document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for(var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if(cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        var xhr;

        <!-- 카테고리 삽입, 수정, 삭제 -->
        function category_insertBtn(elem) {
            var input = elem.previousElementSibling;
            var newMid = input.value;
            var baseBig = input.previousElementSibling.value;
            console.log(baseBig);
            if(newMid == '') {
                alert('정보를 입력하세요');
                newMid.focus();
                return false;
            }
            var strurl = "category_mid_insert?category_big=" + baseBig + "&category_mid=" + newMid;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);
                    if(obj.flag == '0') {
                        location.reload();
                    }
                }
            };
            xhr.open("POST", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }
        function category_updateBtn(id, category_id) {
            event.preventDefault();
            var mid_category = document.getElementById(id);
            var mid_value = mid_category.value;
            if(mid_value == '') {
                alert('정보를 입력하세요');
                mid_category.focus();
                return false;
            }
            var strurl = "category_update?category_id=" + category_id + "&mid_category=" + mid_value;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);
                }
            };
            xhr.open("GET", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }
        function category_deleteBtn(id) {
            event.preventDefault();
            var strurl = "category_delete?category_id=" + id;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);

                    document.getElementById('delbox_' + id).remove();

                }
            };
            xhr.open("GET", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }

        <!-- 상품 삽입, 수정, 삭제 -->
        function product_insertBtn(id) {
            var name = document.getElementById("newName_" + id);
            var price = document.getElementById("newPrice_" + id);
            if(name.value == '') {
                alert('상품을 입력하세요');
                name.focus();
                return false;
            } else if(price.value == '') {
                alert('가격을 입력하세요');
                price.focus();
                return false;
            }
            var strurl = "product_insert?category_id=" + id + "&product_name=" + name.value + "&product_price=" + price.value;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);
                    if(obj.flag == '0') {
                        location.reload();
                    }
                }
            };
            xhr.open("POST", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }
        function paging(id){

            var strurl = "product_get?product_id=" + id;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    <!-- 비동기 요청으로 돌려받은 응답을 data에 저장 -->
                    var data = xhr.responseText;
                    <!-- JSON 형태로 파싱 -->
                    var obj = JSON.parse(data);
                    <!-- 불러온 data를 넣을 영역 특정 -->
                    var canvas = document.querySelectorAll(".update_area");

                    var modal_id = canvas[0];
                    var modal_category = canvas[1];
                    var modal_name = canvas[2];
                    var modal_price = canvas[3];
                    <!-- 수정할 수 있도록 input 태그로 변환 -->
                    modal_id.innerHTML = "<input type='text' value='" + obj.product_id + "' readonly/>";
                    modal_category.innerHTML = "<input type='text' value='" + obj.category_id + "'/>";
                    modal_name.innerHTML = "<input type='text' value='" + obj.product_name + "'/>";
                    modal_price.innerHTML = "<input type='date' value='" + obj.product_price + "'/>";
                    <!-- 삭제를 위한 인자 생성 -->
                    var del = document.getElementById("delBtn");
                    var delete_id = obj.product_id;
                    del.setAttribute("data-id", delete_id);
                }
            }
            xhr.open("GET", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }

        function product_updateBtn(id, category_id) {
            event.preventDefault();
            var mid_category = document.getElementById(id);
            var mid_value = mid_category.value;
            if(mid_value == '') {
                alert('정보를 입력하세요');
                mid_category.focus();
                return false;
            }
            var strurl = "category_update?category_id=" + category_id + "&mid_category=" + mid_value;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);
                }
            };
            xhr.open("GET", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }
        function product_deleteBtn(id) {
            event.preventDefault();
            var strurl = "category_delete?category_id=" + id;
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
                    var data = xhr.responseText;

                    var obj = JSON.parse(data);
                    alert(obj.result_msg);

                    document.getElementById('delbox_' + id).remove();

                }
            };
            xhr.open("GET", strurl);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.send(null);
        }
    </script>
{% endblock javascript %}